# Netflix Critic üïµÔ∏è


## Demo
<p align="center">
<img src="./assets/critic-demo.gif" />
</p>

## Motivation
I sometimes spend up to half an hour looking for something to watch on Netflix. Finding something that's guaranteed to not be a waste of time is a huge challenge, and going in blind is a risk I'm not usually willing to take.

### Ratings
Ratings are usually a pretty good signal of quality ‚Äî you can be reasonably certain you'll enjoy a show or movie that's been rated 9/10 by other viewers, unless you have some really niche taste or you're one of those contrarians types.

But why specifically the 'Google users' rating? Simply put, I've found it to be more reliable than any other ratings vendor. In my experience, Rotten Tomatoes and IMDb are often way off the mark (see the [factoids section](#some-factoids) below). I still collect the ratings from these vendors if they're available on the SERP, though.

But the reason I conceived this project was to collect that coveted percentage you see when you google a title:

<p align="center">
<img src="./assets/interstellar.png" />
</p>

## Running Locally
First things first, clone this repo:
`git clone --recurse-submodules https://github.com/adosib/netflix_critic.git`

The extension isn't stand-alone because it depends on the web server (and the Postgres database) to pull data from, so at a minimum you'll need to have [Docker](https://www.docker.com/get-started/) installed.

Once you have Docker installed, open a terminal **from the project root directory** and run 
`docker compose up` after which your local webserver and database will be up and running.

Next you just have to add the extension:
1. Open a browser and navigate to chrome://extensions/
2. Toggle 'Developer mode'
3. Load unpacked extension
4. Select the extension-core directory

At this point you should be set. Now you can browse Netflix, enhanced with ratings.

<p align="center">
<img src="./assets/install-extension.gif" />
</p>

### Collecting Ratings Data
Optional: If you additionally want to actively pull down ratings data for titles that aren't readily available in the database, you should be able to get a free trial with some credits for the [Bright Data SERP API](https://brightdata.com/products/serp-api).

Beyond the free trial credits, it's pay-as-you-go at a rate of $1.50/1000 requests (as of the time of writing), which is very reasonably priced.

Once you've signed up all you need to do is create a .env file at the project root with an environment variable that holds your Bearer authentication token:

```
BRD_AUTH_TOKEN=...
```
*path/to/netflix_critic/.env*

If your zone is called something different from 'serp_api1' then you'll have to set that environment variable, too. You can add the following near the other ENV declarations in the [Webserver.dockerfile](./Webserver.dockerfile):
```
ENV BRD_ZONE=...
```

## Learnings
[TODO]
- `pg_restore` really does not like having the environment variable `PGHOST` set
- When using SSEs with [EventSource](https://developer.mozilla.org/en-US/docs/Web/API/EventSource), you might lose a day debugging if you don't know that `EventSource` really likes endpoints that unambiguously return the mime type `text/event-stream` with an OPTIONS request (i.e. having /api/titles accept POST requests with mime type `application/json` and return responses with type `text/event-stream` is no good).

### Some factoids
Out of 2,356 titles that had ratings from all 3, the distribution shows a clear difference ([code](./scripts/throwaway/plot_ratings.py)):
- Google reviews tend to be more positive compared to IMDb
- Rotten Tomatoes has a slighly higher median rating compared to Google users, but also FAR more variance
- IMDb ratings follow an almost perfect normal distribution, which is suspect to me. I don't think one would expect that with ratings data and I believe it's because of their proprietary [weighting system](https://help.imdb.com/article/imdb/track-movies-tv/weighted-average-ratings).

<p align="center">
<img src="./assets/ratings-plot.png" />
</p>

## Future Work / Loose Ends
- Testing is non-existent.
- Error handling could use some improvement.
- The data in the titles table needs to be cleaned up. There's a lot of "titles" in there that actually correspond to seasons and episodes. It poisons the data model (mixed entities).
- The cost for 1000 Google user ratings is currently sitting around $2.82. The data could be used to drive this toward the optimum of $1.50 (API cost per 1000 requests) by e.g. querying the logs for which "format" of query tends to perform best on first iteration (see [_build_query](./netflix_critic_data/scripts/database_setup/common.py))
- I'd love to include a Reddit sentiment score as part of this. I find the discussions on Reddit are also really helpful for gauging whether or not a movie is worth the watch.
- `JobStore` is not really designed for concurrency, and likely not thread-safe (also not ideal to indefinitely persist that data in memory - need a proper caching mechanism). Same goes for classes like `NetflixSessionHandler` and `BrightDataSessionHandler`.
- The `Availability` model (table) has a `country` attribute but right now all connections are just assumed to be US... the country code could be intercepted from e.g. `netflix.reactContext.models.geo.data.requestCountry.id` and sent as a query parameter when POSTing to /api/titles in the background script.
- The Bright Data API returns a json data structure with more than just the page HTML - might be worth saving the raw JSON and exploring these attributes.

## Misc
Useful commands for (my) reference:
- `pg_dump -Fc -Z zstd:22 -f data/pg_dump/Fc/pg.dump`
- update all submodules `git submodule foreach git pull --ff origin main`
- To debug a container setup, this is a useful command to keep it running indefinitely (to allow for e.g. inspecting the directory structure, etc.): `CMD ["sh", "-c", "while true; do sleep 1000; done"]`